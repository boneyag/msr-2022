{"tags": ["python", "django", "django-orm"], "answers": [{"comments": [{"score": 0, "creation_date": 1507907023, "post_id": 46730352, "comment_id": 80412123, "body": "This queryset generates query that uses subquery for excluding. That&#39;s much less efficient than joins"}, {"score": 0, "creation_date": 1507909687, "post_id": 46730352, "comment_id": 80413704, "body": "i cannot reproduce your setup now, but just updated the answer with a hint. As your M2M references self, you should have available the self relationship to filter with."}], "score": 0, "last_activity_date": 1507909616, "last_edit_date": 1507909616, "answer_id": 46730352, "question_id": 46730084, "body": "<p>what about <code>.exclude()</code> ?</p>\n\n<pre><code>User.objects.exclude(blocked_by__to_user__id=request.user.id)\n</code></pre>\n\n<p>maybe more efficient something like:</p>\n\n<pre><code>User.objects.filter(user__blocked_by__to_user=request.user.id, blocked_by__is_null=True)\n</code></pre>\n"}], "is_answered": false, "answer_count": 1, "score": 0, "last_activity_date": 1507909616, "creation_date": 1507898120, "question_id": 46730084, "title": "Django ORM Multicolumn join", "body": "<p>Users of my app are able to block other users so blocked users won't see their blockers anywhere in the app. I have following models</p>\n\n<pre><code>class User(models.Model):\n    blocked_users = models.ManyToManyField(\n        'self', symmetrical=False, through='Block')\n\n\nclass Block(models.Model):\n    class Meta:\n        unique_together = ('from_user', 'to_user')\n\n    from_user = models.ForeignKey('User', related_name='blocked')\n    to_user = models.ForeignKey('User', related_name='blocked_by')\n</code></pre>\n\n<p>So now I'm trying to make Django do the following query that will return users who didn't block currently logged in user.</p>\n\n<pre><code>SELECT *\nFROM user\nLEFT OUTER JOIN block ON (block.from_user_id = user.id AND block.to_user_id = 1)\nWHERE block.id is null\n</code></pre>\n\n<p>where <code>1</code> is an id of the currently logged in user.</p>\n"}